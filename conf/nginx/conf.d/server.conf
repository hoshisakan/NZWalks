# 內部 DNS：Docker 內通常可用 127.0.0.11
resolver 127.0.0.11 ipv6=off;

upstream dotnet_kestrel_http {
    # 用 docker 服務名「web」，不要用 container_name
    server api:5017;
    # keepalive 64;  # 可選
}

server {
    listen 80;
    listen [::]:80;
    server_name _;  # 接所有 Host

    access_log /var/log/nginx/host.access.log main;

    location / {
        proxy_pass         http://dotnet_kestrel_http;
        proxy_http_version 1.1;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        $connection_upgrade;

        client_max_body_size 200m;
        proxy_read_timeout  120s;
        proxy_send_timeout  120s;

        # 若要限流，請先在 nginx.conf 的 http{} 定義好 limit_req_zone 再啟用：
        # limit_req zone=one nodelay;
    }

    error_page 404 /404.html;

    error_page 500 502 503 504 /50x.html;
    location = /50x.html { root /usr/share/nginx/html; }
}
